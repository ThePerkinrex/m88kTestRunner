name: Release

permissions:
    contents: write

on: [push]

jobs:
    create-release:
        runs-on: ubuntu-latest
        steps:
            - name: Get current date
              id: date
              run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
            - name: Test with environment variables
              run: echo $TAG_NAME - $RELEASE_NAME
              env:
                  TAG_NAME: nightly-tag-${{ steps.date.outputs.date }}-${{ github.sha }}
                  RELEASE_NAME: nightly-release-${{ steps.date.outputs.date }}-${{ github.sha }}
            - uses: actions/checkout@v3
            - name: Release snapshot
              id: release-snapshot
              uses: actions/create-release@latest
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: nightly-tag-${{ steps.date.outputs.date }}-${{ github.sha }}
                  release_name: Nightly ${{ steps.date.outputs.date }} (${{ github.sha }})
                  draft: false
                  prerelease: false

    upload-assets:
        strategy:
            matrix:
                os:
                    - ubuntu-latest
                    - windows-latest
                include:
                    - arch: amd64
                    - target: linux
                      os: ubuntu-latest
                    - target: windows
                      os: windows-latest
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v3
            - name: Build
              run: cargo build --release
            - uses: PeerXu/upload-asset@v1
              with:
                  file: path/to/binary.tar.gz
                  os: ${{ matrix.target }}
                  arch: ${{ matrix.arch }}
                  with_tag: true
                  with_sha1: true
                  # suffix: .tar.gz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
